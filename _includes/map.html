<link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
   integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
   crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
   integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
   crossorigin=""></script>
<script type="text/javascript" src="https://stamen-maps.a.ssl.fastly.net/js/tile.stamen.js?v1.3.0"></script>

<figure id="map-container" style="margin-bottom: 1em;">
	<div id="leaflet-map" style="height: 100%; width: 100%;"></div>
</figure>

<script type="text/javascript">

var defaultIcon = new L.Icon.Default();

function add_geojson_to_map( data, index ) {
    new GeoJSONConverter( data, index );
}

class GeoJSONConverter {

    constructor( data, index ) {
        // expect an object with source and data keys
        this.simple = {{include.simple | jsonify}};
        this.source = data.source;
        this.features = data.data;
        this.line = window.lines.find( object => object.source === this.source );

        /**
         * then define a window.lines array of lines with metadata, including color
         * then match the line to this data based on the index/key
         * then save the color in this class
         * then use this class property to pass the color to the icons
         */
        L.geoJSON( this.features, {
            onEachFeature: this.onEachFeature.bind(this),
            pointToLayer: this.pointToLayer.bind(this),
            style: this.stylePaths.bind(this),
            filter: this.visibility_filter.bind(this)
        }).addTo(window.map);
    }

    /**
     * Bind popups and do other things
     * 
     * This bit from https://tomik23.github.io/leaflet-examples/#15.geoJson-simple
     */
    onEachFeature(feature, layer) {
        let connections = '';
        if (feature.properties.connections) {
            connections = `<p class="connections">Connections: ${feature.properties.connections}</p>`;
        }
        layer.bindPopup(
            `<p class="title">${feature.properties.name}</p><p class="description">${feature.properties.description}</p> ${connections}`,
            {
                className: `phase-${feature.properties.phase} ${feature.properties.icon}`
            }
        );
    }

    /**
     * turn a geojson point into an marker for a layer
     * 
     * this bit from https://leafletjs.com/examples/geojson/
     */
    pointToLayer(feature, latlng) {
        // @todo set up different icons for different shape of feature
        var options = {};
        switch (feature.properties.icon) {
            case 'construction':
                options.icon = this.return_constructionIcon(feature, this);               break;
                break;
            case 'apm':
                options.icon = this.return_apmIcon(feature,);
                break;
            case 'tram':
                options.icon = this.return_tramIcon(feature,);
                break;
            default:
                options.icon = defaultIcon;
        };
        options.riseOnHover = true;
        return L.marker( latlng, options );
    }

    /**
     * Return an icon for a construction thing
     */
    return_constructionIcon( feature ) {
        let color = this.chooseColor( feature.properties.stroke );
        let id = this.featureToMarkerID( feature );
        return new L.DivIcon({
            className: 'icon-custom icon-construction ' + id,
            html: '<div>ðŸš§</div>',
            iconAnchor: [0,0],
            iconSize: 28
        });
    }
    /**
     * Return an icon for a construction thing
     */
    return_tramIcon( feature ) {
        let color = this.chooseColor( feature.properties.stroke );
        let id = this.featureToMarkerID( feature );
        return new L.DivIcon({
            className: 'icon-custom icon-tram ' + id,
            html: '<div style="background-color:' + color + '"></div>',
            iconAnchor: [36,36],
            iconSize: 36
        });
    }
    /**
     * Return an icon for a construction thing
     */
    return_apmIcon( feature ) {
        let color = this.chooseColor( feature.properties.stroke );
        let id = this.featureToMarkerID( feature );
        return new L.DivIcon({
            className: 'icon-custom icon-apm ' + id,
            html: '<div style="background-color:' + color + '"></div>',
            iconAnchor: [36,36],
            iconSize: 36
        });
    }

    /**
     * Give a feature a deterministic ID
     */
    featureToMarkerID( feature ) {
        return 'marker-' + feature.properties.type + '-' + feature.properties.id;
    }

    /**
     * Given some colors, and the page context, determine which color to use for this object
     */
    chooseColor( feature_color ) {
        if ( this.simple ) {
            return this.line.color;
        }
        if ( ! feature_color ) {
            return this.line.color;
        }
        if ( ! feature_color && ! this.line.color ) {
            return black;
        }
        return feature_color;
    }

    /**
     *  Style paths, from https://gis.stackexchange.com/questions/158227/leaflet-geojson-problem-with-style
     */
    stylePaths(feature) {
        feature.color     = this.chooseColor( feature.properties['stroke'] );
        feature.stroke    = this.chooseColor( feature.properties['stroke'] );
        feature.dashArray = feature.properties['dashArray'] ??= null;
        feature.weight    = feature.properties['stroke-width'] ??= 4;
        return feature;
    }

    /**
     * Control whether a given feature displays on this page
     */
    visibility_filter(feature, layer) {
        if ( this.simple ) {
            return ( feature.properties.simple === 'true' );
        }
        return true;
    }
}

function init () {
    window.map = L.map('leaflet-map', {minZoom: 11, maxZoom:17}).setView([40, -83.00], 12);

    var stamen = new L.StamenTileLayer('toner-lite', {
        maxZoom: 17
    })
    window.map.addLayer(stamen);
    window.line_geojson.forEach( (data) => add_geojson_to_map( data ) );
    window.map.fitBounds();
}
init();

// debug tools
var popup = L.popup({
    offset:[16,-16]
});
function onMapClick(event) {
    popup.setContent(
    "<p>you clicked the map at " + event.latlng.toString() + "</p>"
    )
    .setLatLng(event.latlng)
    .openOn(window.map);
}
window.map.on('click', onMapClick);

/**
 * Given a map ID, find it and focus on its Marker.
 * 
 * This assumes that IDs are selectors.
 */
function zoom_to_feature( id ) {
    window.map.setZoom(14);
    document.querySelector( id ).click();
    console.log( id );
}

</script>